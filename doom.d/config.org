#+TITLE: Emacs Config
#+STARTUP: fold

* Startup
#+BEGIN_SRC emacs-lisp :comments no
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-
#+END_SRC
* Personal Info
Some functionality uses this to identify you, e.g. GPG configuration, email
clients, file templates and snippets.

#+BEGIN_SRC emacs-lisp
(setq user-full-name "Abhishek Bansal"
      user-mail-address "abhibansal530@gmail.com")
#+END_SRC
* Theme and look
** Font
#+BEGIN_SRC emacs-lisp
(setq doom-font (font-spec :family "Meslo LG S for Powerline" :size 18))
#+END_SRC
** Theme
#+BEGIN_SRC emacs-lisp
(setq doom-theme 'gruvbox-dark-soft)
#+END_SRC
** Misc
This determines the style of line numbers in effect. If set to `nil', line
numbers are disabled. For relative line numbers, set this to `relative'.
#+BEGIN_SRC emacs-lisp
(setq display-line-numbers-type t)
#+END_SRC
* Org mode
** Defaults
If you use `org' and don't want your org files in the default location below,
change `org-directory'. It must be set before org loads!
#+BEGIN_SRC emacs-lisp
(setq org-directory "~/org/")
#+END_SRC

** Main
#+BEGIN_SRC emacs-lisp
(after! org
  (require 'find-lisp)
  (setq org-ditaa-jar-path "/usr/local/Cellar/ditaa/0.11.0_1/libexec/ditaa-0.11.0-standalone.jar")
  (setq org-startup-folded t)
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "SOMEDAY(s)" "PROJECT(p)" "|" "DONE(d)")
          (sequence "WAITING(w@/!)" "HOLD(h@/!)" "|" "CANCELLED(c@/!)")))

  ;; Alghout all of these are not required for agenda, but adding these allow for searching tags across all these files.
  (setq org-agenda-files (append '("~/org/gtd/inbox.org" "~/org/gtd/life.org" "~/org/gtd/projects.org")
                                 (directory-files-recursively "~/org/resources" "\\.org$")))

  (setq org-complete-tags-always-offer-all-agenda-tags t)

  (setq org-refile-allow-creating-parent-nodes 'confirm)

  (setq org-refile-targets '(("~/org/gtd/projects.org" :maxlevel . 1)
                             ("~/org/gtd/life.org" :maxlevel . 3))))
#+END_SRC

** Capture
#+BEGIN_SRC emacs-lisp
(after! org-capture
  (setq org-capture-templates
        `(("i" "Inbox")

          ("iP" "Personal inbox" entry
           (file "~/org/gtd/inbox.org")
           (file "~/org/capture-templates/inbox.txt")
           :empty-lines-after 1)

          ("iW" "Work inbox" entry
           (file "~/org/gtd/work/inbox.org")
           (file "~/org/capture-templates/inbox.txt")
           :empty-lines-after 1)

          ("c" "org-protocol-capture" entry
           (file "~/org/gtd/inbox.org")
           (file "~/org/capture-templates/protocol.txt")
           :immediate-finish t)

          ("g" "GTD templates")

          ("gp" "Create a daily plan")

          ("gpP" "Daily plan private" plain
           (file+olp+datetree "~/org/gtd/planner.org")
           (file "~/org/capture-templates/daily-plan.txt")
           :immediate-finish t)

          ("gpW" "Daily plan work" plain
           (file+olp+datetree "~/org/gtd/work/planner.org")
           (file "~/org/capture-templates/daily-plan-work.txt")
           :immediate-finish t)

          ("gr" "Review templates")

          ("grd" "Daily review" plain
           (file+olp+datetree "~/org/gtd/life.org" "GTD" "Daily Review")
           (file "~/org/capture-templates/daily-review.txt")
           :immediate-finish t
           :jump-to-captured t)

          ("grw" "Weekly review" plain
           (file+olp+datetree "~/org/gtd/life.org" "GTD" "Weekly Review")
           (file "~/org/capture-templates/weekly-review.txt")
           :immediate-finish t
           :jump-to-captured t)

          ("r" "Capture a resource")

          ("rB" "Book" entry
           (file "~/org/resources/books.org")
           (file "~/org/capture-templates/book.txt")
           :empty-lines-after 2))))
#+END_SRC
** Protocol
Setup org-protocol to enable capture using firefox
#+BEGIN_SRC emacs-lisp
(add-to-list 'load-path "~/.emacs.d/.local/straight/repos/org-mode/lisp/org-protocol.el")
(require 'org-protocol)
#+END_SRC
** Agenda
Define custom agenda views.
#+BEGIN_SRC emacs-lisp
(use-package! org-agenda
  :init
  :config
  (setq abhi/org-agenda-directory "~/org/gtd/")
  (setq org-columns-default-format "%40ITEM(Task) %Effort(EE){:} %CLOCKSUM(Time Spent) %SCHEDULED(Scheduled) %DEADLINE(Deadline)")
  (setq org-agenda-custom-commands `(("c" "Agenda"
                                      ((agenda ""
                                               ((org-agenda-span 'week)
                                                (org-deadline-warning-days 365)))
                                       (todo "TODO"
                                             ((org-agenda-overriding-header "To Refile")
                                              (org-agenda-files '(,(concat abhi/org-agenda-directory "inbox.org")))))
                                       (todo "NEXT"
                                             ((org-agenda-overriding-header "In Progress")
                                              (org-agenda-files '(,(concat abhi/org-agenda-directory "projects.org")
                                                                  ,(concat abhi/org-agenda-directory "next.org")))
                                              ))
                                       (todo "TODO"
                                             ((org-agenda-overriding-header "Projects")
                                              (org-agenda-files '(,(concat abhi/org-agenda-directory "projects.org")))
                                              ))
                                       (todo "TODO"
                                             ((org-agenda-overriding-header "One-off Tasks")
                                              (org-agenda-files '(,(concat abhi/org-agenda-directory "next.org")))
                                              (org-agenda-skip-function '(org-agenda-skip-entry-if 'deadline 'scheduled))))))

                                     ("i" "Inbox"
                                      ((todo ""
                                            ((org-agenda-overriding-header "To Refile")
                                             (org-agenda-files '(,(concat abhi/org-agenda-directory "inbox.org"))))))))))
#+END_SRC
** Roam
#+BEGIN_SRC emacs-lisp
(use-package! org-roam
  :hook
  (after-init . org-roam-mode)
  :config
  (setq org-roam-ref-capture-templates
        '(("r" "ref" plain (function org-roam-capture--get-point)
           "%?"
           :file-name "${slug}"
           :head "#+TITLE: ${title}
    #+ROAM_KEY: ${ref}
    #+ROAM_TAGS: Website
    - source :: ${ref}"
           :unnarrowed t)))
  (setq +org-roam-open-buffer-on-find-file nil))
#+END_SRC
** Journal
Store journal entries inside roam directory.
#+BEGIN_SRC emacs-lisp
(use-package org-journal
  :custom
  (org-journal-dir (concat org-roam-directory "/journal"))
  (org-journal-date-prefix "#+TITLE: ")
  (org-journal-file-format "%Y-%m-%d.org")
  (org-journal-date-format "%A, %d %B %Y"))
#+END_SRC
** Refile
My custom hydra for refiling. Ref :
- http://www.howardism.org/Technical/Emacs/getting-more-boxes-done.html
- https://mollermara.com/blog/Fast-refiling-in-org-mode-with-hydras/

#+BEGIN_SRC emacs-lisp
(defmacro my-org-make-refile-command (fn-suffix refile-targets)
  "Generate a command to call `org-refile' with modified targets."
  `(defun ,(intern (concat "my-org-refile-" (symbol-name fn-suffix))) ()
     ,(format "`org-refile' to %S" refile-targets)
     (interactive)
     (org-refile-cache-clear)
     (let ((org-refile-target-verify-function nil)
           (org-refile-history nil)
           (org-refile-targets ,refile-targets))
       (if (eq major-mode 'org-agenda-mode)
           (call-interactively 'org-agenda-refile)
         (call-interactively 'org-refile)))))

(my-org-make-refile-command book '(("~/org/resources/books.org" :maxlevel . 2)))
(my-org-make-refile-command course '(("~/org/resources/courses.org" :maxlevel . 1)))
(my-org-make-refile-command link '(("~/org/resources/links.org" :maxlevel . 1)))
(my-org-make-refile-command paper '(("~/org/resources/papers.org" :maxlevel . 1)))
(my-org-make-refile-command read '(("~/org/resources/readings.org" :maxlevel . 1)))
(my-org-make-refile-command watch '(("~/org/resources/watch.org" :maxlevel . 1)))
(my-org-make-refile-command project '(("~/org/gtd/projects.org" :maxlevel . 1)))
(my-org-make-refile-command people '(("~/org/resources/people.org" :maxlevel . 1)))

(defhydra my-org-refile-hydra (:hint nil :foreign-keys run)
  "
^Refile^            ^Goto^                     ^Dired^
------------------------------------------------------
_p_: Projects       _g j_: Last refile         _d r_: Resources
_P_: Papers         _g r_: To Read
_b_: Books          _g p_: Projects
_c_: Courses
_l_: Links
_r_: To Read
_w_: To Watch
_o_: People
_R_: Refile
"
  ("b" my-org-refile-book)
  ("c" my-org-refile-course)
  ("l" my-org-refile-link)
  ("p" my-org-refile-project)
  ("P" my-org-refile-paper)
  ("r" my-org-refile-read)
  ("w" my-org-refile-watch)
  ("o" my-org-refile-people)
  ("R" org-refile)
  ("g j" org-refile-goto-last-stored :exit t)
  ("g r" (find-file-other-window "~/org/resources/readings.org") :exit t)
  ("g p" (find-file-other-window "~/org/gtd/projects.org") :exit t)
  ("d r" (dired "~/org/resources") :exit t)
  ("q" nil "cancel"))

(global-set-key (kbd "<f9> r") 'my-org-refile-hydra/body)
#+END_SRC
** Misc
Use deft for searching org files :
#+BEGIN_SRC emacs-lisp
(use-package deft
      :after org
      :custom
      (deft-recursive t)
      (deft-use-filter-string-for-filename t)
      (deft-default-extension "org")
      (deft-directory org-roam-directory))
#+END_SRC

Don't rememer this one :

#+BEGIN_SRC emacs-lisp
(eval-after-load "artist"
  '(define-key artist-mode-map [(down-mouse-3)] 'artist-mouse-choose-operation)
  )
#+END_SRC
* Ebook reading
For reading epubs :
#+BEGIN_SRC emacs-lisp
(use-package! nov
  :mode ("\\.epub\\'" . nov-mode)
  :config
  (setq nov-save-place-file (concat doom-cache-dir "nov-places")))
#+END_SRC
